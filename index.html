<script>
document.addEventListener("DOMContentLoaded", function() {
    // --- DB DE APERTURAS (SIMPLIFICADA) ---
    const openings = { "rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq - 0 1": "Apertura de Peón de Rey", "rnbqkbnr/pppp1ppp/8/4p3/4P3/8/PPPP1PPP/RNBQKBNR w KQkq - 0 2": "Juego Abierto", "rnbqkbnr/pppp1ppp/8/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R b KQkq - 1 2": "Juego de Caballo de Rey", "r1bqkbnr/pppp1ppp/2n5/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R w KQkq - 2 3": "Apertura Italiana/Española", "rnbqkb1r/pppp1ppp/5n2/4p3/2B1P3/8/PPPP1PPP/RNBQK1NR w KQkq - 2 3": "Apertura Italiana: Giuoco Piano", "rnbqkbnr/pp1ppppp/8/2p5/4P3/8/PPPP1PPP/RNBQKBNR w KQkq - 0 2": "Defensa Siciliana" };

    const game = new Chess();
    const pieceUnicode = { w: {p: '♙', r: '♖', n: '♘', b: '♗', q: '♕', k: '♔'}, b: {p: '♟', r: '♜', n: '♞', b: '♝', q: '♛', k: '♚'} };
    const boardElement = document.querySelector('.chessboard');
    const moveHistoryElement = document.getElementById('move-history');
    const promotionModal = document.getElementById('promotion-modal');
    
    let selectedSquare = null;
    let orientation = 'white';
    
    // --- LÓGICA DEL RELOJ ---
    const INITIAL_TIME = 5 * 60; // 5 minutos
    let timers = { w: INITIAL_TIME, b: INITIAL_TIME };
    let timerInterval = null;
    
    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = seconds % 60;
        return `${min}:${sec < 10 ? '0' : ''}${sec}`;
    }

    function updateClocks() {
        document.getElementById('clock-white').innerText = formatTime(timers.w);
        document.getElementById('clock-black').innerText = formatTime(timers.b);
        ['white', 'black'].forEach(color => {
            const clockElement = document.getElementById(`clock-${color}`);
            // El efecto de "low-time" se mantiene basado en el tiempo restante
            if (timers[color.charAt(0)] < 60 && timers[color.charAt(0)] > 0) {
                clockElement.classList.add('low-time');
            } else {
                clockElement.classList.remove('low-time');
            }
        });
    }

    // --- NUEVA FUNCIÓN ---
    function switchActiveClock() {
        document.getElementById('clock-white').classList.remove('active');
        document.getElementById('clock-black').classList.remove('active');
        if (!game.game_over()) {
            document.getElementById(`clock-${game.turn()}`).classList.add('active');
        }
    }
    
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (game.game_over()) { clearInterval(timerInterval); return; }
            const turn = game.turn();
            timers[turn]--;
            if (timers[turn] <= 0) {
                clearInterval(timerInterval);
                timers[turn] = 0;
                document.getElementById('status-panel').innerText = `¡Se acabó el tiempo! Ganan las ${turn === 'b' ? 'Blancas' : 'Negras'}.`;
                // Para el estado del juego, una forma de "rendirse" por tiempo.
                game.load('4k3/8/8/8/8/8/8/4K3 w - - 0 1');
            }
            updateClocks();
        }, 1000);
    }
    
    const coordsToAlgebraic = (row, col) => String.fromCharCode('a'.charCodeAt(0) + col) + (8 - row);
    
    function drawBoard() {
        boardElement.innerHTML = '';
        const boardState = game.board();
        const rows = orientation === 'white' ? Array.from(Array(8).keys()) : Array.from(Array(8).keys()).reverse();
        for (const i of rows) {
            const cols = orientation === 'white' ? Array.from(Array(8).keys()) : Array.from(Array(8).keys()).reverse();
            for (const j of cols) {
                const square = document.createElement('div');
                square.dataset.square = coordsToAlgebraic(i, j);
                square.className = `square ${(i + j) % 2 === 0 ? 'light' : 'dark'}`;
                const piece = boardState[i][j];
                if (piece) {
                    square.innerHTML = `<span class="piece ${piece.color}" draggable="true">${pieceUnicode[piece.color][piece.type]}</span>`;
                }
                boardElement.appendChild(square);
            }
        }
        highlightLastMove(); addEventListeners(); updateAllInfo();
    }
    
    function highlightLastMove() {
        document.querySelectorAll('.last-move-highlight').forEach(el => el.classList.remove('last-move-highlight'));
        const lastMove = game.history({verbose: true}).pop();
        if (lastMove) {
            document.querySelector(`[data-square="${lastMove.from}"]`)?.classList.add('last-move-highlight');
            document.querySelector(`[data-square="${lastMove.to}"]`)?.classList.add('last-move-highlight');
        }
    }

    function handleMove(source, target, promotionPiece) {
        if (game.game_over()) return;
        const move = game.move({ from: source, to: target, promotion: promotionPiece });
        if (move !== null) { 
            if (game.history().length === 1 && !timerInterval) startTimer();
            // --- CAMBIO IMPORTANTE AQUÍ ---
            // Inmediatamente después de un movimiento válido, cambiamos el reloj activo
            switchActiveClock();
            drawBoard(); 
        } 
        else { clearHighlights(); selectedSquare = null; }
    }

    function showPromotionDialog(from, to) {
        const turn = game.turn();
        promotionModal.innerHTML = `<span class="piece ${turn}" data-piece="q">${pieceUnicode[turn]['q']}</span><span class="piece ${turn}" data-piece="r">${pieceUnicode[turn]['r']}</span><span class="piece ${turn}" data-piece="b">${pieceUnicode[turn]['b']}</span><span class="piece ${turn}" data-piece="n">${pieceUnicode[turn]['n']}</span>`;
        promotionModal.style.display = 'flex';
        promotionModal.querySelectorAll('.piece').forEach(p => {
            p.onclick = () => { promotionModal.style.display = 'none'; handleMove(from, to, p.dataset.piece); };
        });
    }
    
    function clearHighlights() { document.querySelectorAll('.square.selected, .square.legal-move-dot').forEach(sq => sq.classList.remove('selected', 'legal-move-dot')); }

    function onSquareClick(e) {
        const squareElement = e.currentTarget;
        const squareAlg = squareElement.dataset.square;
        if (selectedSquare) {
            handleMove(selectedSquare, squareAlg);
            selectedSquare = null;
        } else {
            const piece = game.get(squareAlg);
            if (piece && piece.color === game.turn()) {
                selectedSquare = squareAlg;
                clearHighlights();
                squareElement.classList.add('selected');
                game.moves({ square: squareAlg, verbose: true }).forEach(move => {
                    document.querySelector(`[data-square="${move.to}"]`)?.classList.add('legal-move-dot');
                });
            }
        }
    }

    function updateMoveHistory() {
        moveHistoryElement.innerHTML = '';
        const moves = game.history({ verbose: true });
        for (let i = 0; i < moves.length; i += 2) {
            const moveNumber = (i / 2) + 1;
            const moveWhite = moves[i].san;
            const moveBlack = moves[i + 1] ? moves[i + 1].san : '';
            moveHistoryElement.innerHTML += `<div class="move"><span class="move-number">${moveNumber}.</span><span>${moveWhite}</span><span>${moveBlack}</span></div>`;
        }
        moveHistoryElement.scrollTop = moveHistoryElement.scrollHeight;
    }

    function updateCapturedPieces() {
        const captured = { w: [], b: [] };
        const initialCounts = { p: 8, r: 2, n: 2, b: 2, q: 1 };
        const boardPieces = game.board().flat().filter(p => p);
        for (const type in initialCounts) {
            const whiteOnBoard = boardPieces.filter(p => p.type === type && p.color === 'w').length;
            const blackOnBoard = boardPieces.filter(p => p.type === type && p.color === 'b').length;
            for(let i=0; i< initialCounts[type] - whiteOnBoard; i++) captured.b.push(pieceUnicode['w'][type]);
            for(let i=0; i< initialCounts[type] - blackOnBoard; i++) captured.w.push(pieceUnicode['b'][type]);
        }
        document.getElementById('captured-white').innerHTML = captured.w.sort().join(' ');
        document.getElementById('captured-black').innerHTML = captured.b.sort().join(' ');
    }
    
    function addEventListeners() { document.querySelectorAll('.square').forEach(square => square.addEventListener('click', onSquareClick)); }

    function updateStatus() {
        let status = '';
        const lastMove = game.history({verbose: true}).pop();
        if(lastMove) {
            if (lastMove.flags.includes('k')) status = "¡Enroque corto!";
            else if (lastMove.flags.includes('q')) status = "¡Enroque largo!";
            else if (lastMove.flags.includes('c')) status = "¡Captura!";
            else if (lastMove.flags.includes('e')) status = "¡Captura al paso!";
            else if (lastMove.flags.includes('p')) status = "¡Promoción!";
        }
        const moveColor = game.turn() === 'w' ? 'Blancas' : 'Negras';
        
        if (game.game_over()) {
            if (game.in_checkmate()) { status = `¡Jaque Mate! Ganan las ${moveColor === 'Negras' ? 'Blancas' : 'Negras'}.`; }
            else { status = "La partida es tablas."; }
            if (timerInterval) clearInterval(timerInterval);
        } else if (status === '') {
            status = `Mueven las ${moveColor}.`;
        }
        if (game.in_check() && !game.in_checkmate()) {
            status = "¡Jaque! " + status;
        }
        document.getElementById('status-panel').innerText = status;
    }

    function updateOpeningName() {
        const simplifiedFen = game.fen().split(' ').slice(0, 4).join(' ');
        const opening = openings[simplifiedFen];
        if (opening && game.history().length < 20) {
            document.getElementById('opening-name').innerText = opening;
        }
    }
    
    function updateAllInfo() {
        updateStatus();
        updateMoveHistory();
        updateCapturedPieces();
        updateOpeningName();
    }
    
    // Controles
    document.getElementById("resetBtn").onclick = () => { 
        game.reset(); 
        selectedSquare = null; 
        timers = { w: INITIAL_TIME, b: INITIAL_TIME };
        clearInterval(timerInterval);
        timerInterval = null;
        updateClocks();
        switchActiveClock();
        document.getElementById('opening-name').innerText = '...';
        document.getElementById('status-panel').innerText = '¡Mucha suerte!';
        drawBoard();
    };
    document.getElementById("undoBtn").onclick = () => {
        // Deshacer para ambos jugadores para mantener la paridad de turnos
        game.undo(); 
        game.undo(); 
        drawBoard(); 
        selectedSquare = null; 
        // No se ajusta el tiempo en deshacer para simplicidad
    };
    document.getElementById("flipBtn").onclick = () => { orientation = orientation === 'white' ? 'black' : 'white'; drawBoard(); };
    
    // --- INICIALIZACIÓN ---
    drawBoard();
    updateClocks();
    switchActiveClock();
});
</script>
